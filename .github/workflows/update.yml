name: Update DW-Proton

on:
  schedule:
    - cron: "0 0 * * *"  # Daily at midnight
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v19

      - name: Check for new version
        id: check_version
        run: |
          # Get current version from default.nix
          CURRENT_VERSION=$(grep 'version = ' default.nix | sed 's/.*version = "\(.*\)";/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Get latest release from DawnWine Forgejo API with error handling
          echo "Fetching releases from DawnWine API..."
          RESPONSE=$(curl -s -w "\n%{http_code}" "https://dawn.wine/api/v1/repos/dawn-winery/dwproton/releases")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          JSON_RESPONSE=$(echo "$RESPONSE" | head -n -1)

          echo "HTTP Status Code: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: DawnWine API returned HTTP $HTTP_CODE"
            echo "Response: $JSON_RESPONSE"
            exit 1
          fi

          # Check if response is valid JSON and contains releases
          if ! echo "$JSON_RESPONSE" | jq empty 2>/dev/null; then
            echo "Error: Invalid JSON response from DawnWine API"
            echo "Response: $JSON_RESPONSE"
            exit 1
          fi

          # Check if response is an array
          if [ "$(echo "$JSON_RESPONSE" | jq 'type')" != '"array"' ]; then
            echo "Error: DawnWine API response is not an array"
            echo "Response type: $(echo "$JSON_RESPONSE" | jq 'type')"
            echo "Response: $JSON_RESPONSE"
            exit 1
          fi

          # Get the latest dwproton release tag
          LATEST_TAG=$(echo "$JSON_RESPONSE" | jq -r '.[] | select(.tag_name | startswith("dwproton-")) | .tag_name' | head -1)

          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "Error: Could not find dwproton release"
            echo "Available releases:"
            echo "$JSON_RESPONSE" | jq -r '.[].tag_name' | head -10
            exit 1
          fi

          # Remove 'dwproton-' prefix to get version
          LATEST_VERSION=${LATEST_TAG#dwproton-}

          echo "Latest tag: $LATEST_TAG"
          echo "Latest version: $LATEST_VERSION"

          # Check if version is different
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "New version available!"
            echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
            echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "No update needed"
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Calculate new hash
        if: steps.check_version.outputs.update_needed == 'true'
        id: calc_hash
        run: |
          URL="https://dawn.wine/dawn-winery/dwproton/releases/download/${{ steps.check_version.outputs.latest_tag }}/dwproton-${{ steps.check_version.outputs.latest_version }}-x86_64.tar.xz"
          echo "Calculating hash for: $URL"

          HASH=$(nix-prefetch-url --unpack "$URL")
          SRI_HASH=$(nix hash convert --to sri sha256:$HASH)
          echo "Hash: $HASH"
          echo "SRI Hash: $SRI_HASH"
          echo "sri_hash=$SRI_HASH" >> $GITHUB_OUTPUT

      - name: Update default.nix
        if: steps.check_version.outputs.update_needed == 'true'
        run: |
          # Update version
          sed -i 's/version = ".*";/version = "${{ steps.check_version.outputs.latest_version }}";/' default.nix

          # Update hash (using SRI format) - use | as delimiter to avoid issues with / in hash
          sed -i 's|hash = ".*";|hash = "${{ steps.calc_hash.outputs.sri_hash }}";|' default.nix

      - name: Create Pull Request
        if: steps.check_version.outputs.update_needed == 'true'
        id: create_pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "Update dwproton to ${{ steps.check_version.outputs.latest_version }}"
          title: "Update dwproton to ${{ steps.check_version.outputs.latest_version }}"
          body: |
            Automated update of dwproton from ${{ steps.check_version.outputs.current_version }} to ${{ steps.check_version.outputs.latest_version }}.
            - **Previous version**: ${{ steps.check_version.outputs.current_version }}
            - **New version**: ${{ steps.check_version.outputs.latest_version }}
            - **Release tag**: ${{ steps.check_version.outputs.latest_tag }}
            - **Release URL**: https://dawn.wine/dawn-winery/dwproton/releases/tag/${{ steps.check_version.outputs.latest_tag }}
            This PR was automatically generated by the update workflow.
          branch: update-dwproton
          delete-branch: true

      - name: Approve Pull Request
        if: steps.check_version.outputs.update_needed == 'true' && steps.create_pr.outputs.pull-request-number != ''
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          pull-request-number: ${{ steps.create_pr.outputs.pull-request-number }}
